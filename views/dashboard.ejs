<!DOCTYPE html>
<html lang="en">
   <head>
      <!-- basic -->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- mobile metas -->
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="viewport" content="initial-scale=1, maximum-scale=1">
      <!-- site metas -->
      <title>Chat Service</title>
      <meta name="keywords" content="">
      <meta name="description" content="">
      <meta name="author" content="">
      <!-- site icon -->
      <link rel="icon" href="/images/fevicon.png" type="image/png" />
      <style></style>
      <!-- bootstrap css -->
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
      <!-- site css -->
      <link rel="stylesheet" href="/style.css" />
      <!-- responsive css -->
      <link rel="stylesheet" href="/css/responsive.css" />
      <!-- select bootstrap -->
      <link rel="stylesheet" href="/css/bootstrap-select.css" />
      <!-- scrollbar css -->
      <link rel="stylesheet" href="/css/perfect-scrollbar.css" />
      <!-- custom css -->
      <link rel="stylesheet" href="/css/custom.css" />
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.2/socket.io.js" integrity="sha512-jMNwWSmjje4fjYut9MBGKXw5FZA6D67NHAuC9szpjbbjg51KefquNfvn4DalCbGfkcv/jHsHnPo1o47+8u4biA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
   </head>
   <body class="dashboard dashboard_1">
      <div class="full_container">
         <div class="inner_container">
            <!-- Sidebar  -->
            <nav id="sidebar">
               <div class="sidebar_blog_1">
                  <div class="sidebar-header">
                     <div class="logo_section">
                        <a href="index.html"><img class="logo_icon img-responsive" src="images/logo/logo_icon.png" alt="#" /></a>
                     </div>
                  </div>
                  <div class="sidebar_user_info">
                     <div class="icon_setting"></div>
                     <div class="user_profle_side">
                        <div class="user_img"><img class="img-responsive" src="images/layout_img/user_img.jpg" alt="#" /></div>
                        <div class="user_info">
                           <h6><%= user.name%></h6>
                           <p><span class="online_animation"></span></p>
                        </div>
                     </div>
                  </div>
               </div>
               <div class="sidebar_blog_2">
                  <h4>Chat System</h4>
                  <ul class="list-unstyled components">
                    
                     <li><a href="/dashboard"><i class="fa fa-home orange_color"></i> <span>Chat</span></a></li>
                     <li><a href="/groups"><i class="fa fa-group orange_color"></i> <span>Groups</span></a></li>
                     <li><a href="/logout"><i class="fa fa-sign-out purple_color2"></i> <span>Logout</span></a></li>
                    
                     
                  </ul>
               </div>
            </nav>
            <!-- end sidebar -->
            <!-- right content -->
            <div id="content">
              
               <!-- dashboard inner -->
               <div class="midde_cont">
                  <div class="container-fluid">
                     <h1 class="text-danger text-danger">Hi <%= user.name%></h1>
                     <div class="row">
                        <div class="col-md-3">
                            <ul class="list-group">
                                    <% for (let i= 0; i < users.length; i++ ) {%>
                                        <li class="list-group-item list-group-item-dark user-list" style="cursor: pointer;" data-id="<%= users[i]._id%>">
                                            <img src="images/layout_img/msg4.png" alt="" width="40px" height="30px" style="border-radius: 50%;"> 
                                            <% if( users[i].is_online == 1) {%>
                                             <span class="online_animation" id="<%= users[i]._id%>"></span>
                                          <%} else {%>
                                          <%} %>
                                            <%= users[i].name %>
                                            
                                        </li>
                                    <% }%>
                            </ul>
                        </div>
                        <div class="col-md-9">
                            <h3 class="start-head">Click to start the chat</h3>
                            <div class="chat-section" style="display: none;">
                                <div id="chat-container" style="background-color: skyblue;width: 100%;
                                height: 400px; overflow: scroll;">
                                    <div class="m-5">
                                      <!-- current user chat -->
                                      
                                      <!-- end current user chat -->
                                      <!-- dynamic user chat -->
                                      
                                      <!-- end dynamic user chat -->
                                    </div>
                                </div>
                                <form action="" id="chat-form" >
                                    <input type="text" id="message" class="message w-50 border" placeholder="Enter message" required>
                                    <button type="submit" class="btn btn-sm btn-success"> <i class="fa fa-paper-plane" aria-hidden="true"></i></button>
                                </form>
                            </div>
                        </div>
                     </div>
                  </div>
                  <!-- footer -->
                  <div class="container-fluid">
                     <div class="footer">
                        <p>Copyright Â© 2018 Designed by html.design. All rights reserved.<br><br>
                           Distributed By: <a href="https://themewagon.com/">ThemeWagon</a>
                        </p>
                     </div>
                  </div>
               </div>
               <!-- end dashboard inner -->
            </div>
         </div>
      </div>
    
         
         <!--Delete Chat  Modal -->
         <div class="modal fade" id="deleteChatModel" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">Delete Chat</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                  </button>
               </div>
               <form id="delete-chat-form">
                  <div class="modal-body">
                     <input type="hidden" name="id" id="delete-message-id">
                     <p class="text-danger">Are you Sure to delete this Message?</p>
                     <p><b id="delete-message"></b></p>
                   </div>
                   <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-danger">Delete</button>
                   </div>
               </form>
            </div>
            </div>
         </div>
          <!-- Modal -->
          <div class="modal fade" id="editChatModel" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">Edit Chat</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                  </button>
               </div>
               <form id="update-chat-form">
                  <div class="modal-body">
                     <input type="hidden" name="id" id="edit-message-id">
                     <input class="form-control" type="text" name="message" id="update-message" required placeholder="Enter message" >
                   </div>
                   <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-success">Update</button>
                   </div>
               </form>
            </div>
            </div>
         </div>
      <!-- jQuery -->
      <!-- <script src="/js/jquery.min.js"></script> -->
      <script src="/js/popper.min.js"></script>
      <script src="/js/bootstrap.min.js"></script>
      <!-- wow animation -->
      <script src="/js/animate.js"></script>
      <!-- select country -->
      <script src="/js/bootstrap-select.js"></script>
    
      <script src="/js/utils.js"></script>
      <script src="/js/analyser.js"></script>
      <!-- nice scrollbar -->
      <script src="/js/perfect-scrollbar.min.js"></script>
      <script>
         var ps = new PerfectScrollbar('#sidebar');
      </script>
      <!-- custom js -->
      <script src="/js/custom.js"></script>
      <script src="/js/chart_custom_style1.js"></script>
        <!-- Custom jqurey for chat Box -->
        <script>

         
            const socket= io('/user-namespace',{
               auth:{
                  token: '<%= user._id%>'
               }
            });
            let sender_id= '<%= user._id%>';
            let reciver_id;

            // jqurey show or hide message container

            $(document).ready(function(){
                $('.user-list').click(function(){
                  // getting senderId
                  let userId= $(this).attr('data-id');
                     reciver_id= userId

                    $('.start-head').toggleClass('bb');
                    $('.chat-section').toggleClass('aa');

                    socket.emit('exitChat',{sender_id:sender_id, reciver_id:reciver_id})
                })
            });

            // get user online status
            socket.on('online', async (data)=>{
               $('#'+data.user_id).removeClass('online_animation')
            })

            //getuser offline status
            socket.on('online', async (data)=>{
               $('#'+ data.user_id);
               $('#'+data.user_id).addClass('online_animation')
            })

            //chat save of user
            $('#chat-form').submit((event)=>{
               event.preventDefault();
              var message=  $('#message').val();
              //clear input message
               event.target.elements.message.value='';
               event.target.elements.message.focus();

               $.ajax({
                  url:"/save-message",
                  type:"POST",
                  data:{sender_id:sender_id, reciver_id:reciver_id,message:message},
                  success:(response)=>{
                     if(response.success){
                        $("#message").val();
                        let chat= response.data.message;
                        let html=`
                           <div class="" id='`+ response.data._id +`'>
                              <h6 class="my-5"><span class="bg-primary p-2 float-right" style="border-radius: 5px;">`+ chat +`</span>
                                 </h6>
                                 <i class=" fa fa-trash user-trash text-danger float-right" data-toggle="modal" data-target="#deleteChatModel" data-id='`+ response.data._id +`' ></i>

                                 <i class="fa fa-edit  text-primary float-right" data-toggle="modal" data-target="#editChatModel" data-id='`+ response.data._id +`' data-msg='`+ chat +`'></i>
                           </div>
                           <br>
                        `;
                        $('#chat-container').append(html);
                        socket.emit('newChat', response.data)
                        scrollChat()
                     }
                     else{
                        console.log('bb')
                     }
                  }
               })
            
            })

          //Load New Chat
          socket.on('loadNewChat',(data)=>{
            if(sender_id === data.reciver_id && reciver_id == data.sender_id){
               let html=`
               <div class="" id='`+ data._id +`'>
                  <h6 class="my-5"><span class="bg-primary p-2 " style="border-radius: 5px;">
                  `+ data.message +`
               </span>
               </h6>   
               </div>
               <br>
               `;
               $("#chat-container").append(html);
               scrollChat()
            }
              
          })

         //  lading Old Chat 
         socket.on('loadChats', async (data)=>{
            $('#chat-container').html('')
           let chats= data.chats;
           let html='';
           for (let i=0; i<chats.length; i++){
               let addClass='';
               if(chats[i].sender_id === sender_id){
                  addClass= 'current-user-chat'
               }
               else{
                  addClass= 'dynamic-user-chat'
               }
            html += `
            <div class="mt-3 mx-3">
               <div class='`+ addClass +`' id='`+ chats[i]._id+`'>
               <h6 class="my-1">
               <span class="bg-primary p-2 user" style="border-radius: 5px;"> `+chats[i].message+` </span>
            </h6>`;
               if(chats[i].sender_id === sender_id){
               html += ` <i class=" fa fa-trash user-trash text-danger float-right" data-id='`+ chats[i]._id+`' data-toggle="modal" data-target="#deleteChatModel"></i>
               <i class=" fa fa-edit user-edit text-primary float-right" data-id='`+ chats[i]._id+`' data-toggle="modal" data-msg="`+ chats[i].message +`" data-target="#editChatModel"></i>
               `;
               }
             html +=` 
            </div>
            </div>
            <br>
            `;
           }
           $('#chat-container').append(html);

           scrollChat()
         });


         // delete chat work
         $(document).on('click', '.fa-trash', function(){
            let msg= $(this).parent().text();
            $('#delete-message').text(msg);
            $("#delete-message-id").val($(this).attr('data-id'));
         });

         $('#delete-chat-form').submit(function(event){
            event.preventDefault();
            let id= $('#delete-message-id').val();
            $.ajax({
               url:"/delete-message",
               type:"POST",
               data:{id:id},
               success:(response)=>{
                  if(response.success == true){
                     $('#'+id).remove();
                     $('#deleteChatModel').modal('hide')
                     socket.emit('chatDeleted',id)
                  }
                  else{
                    alert(response.msg)
                  }
               }
            })
         });


         // Update User Chat Functionally
         $(document).on('click', '.fa-edit', function(){
            $('#edit-message-id').val($(this).attr('data-id'))
            $('#update-message').val($(this).attr('data-msg'))
         })

         $('#update-chat-form').submit(function(event){
            event.preventDefault();
            let id= $('#edit-message-id').val();
            let msg= $('#update-message').val()
            $.ajax({
               url:"/update-message",
               type:"POST",
               data:{id:id, message:msg},
               success:(response)=>{
                  if(response.success == true){
                     $('#'+id).find('span').text(msg);
                     $('#'+id).find('.fa-edit').attr('data-msg', msg)
                     $('#editChatModel').modal('hide')
                     socket.emit('chatUpdated',{id:id, message:msg})
                  }
                  else{
                    alert(response.msg)
                  }
               }
            })
         });

         socket.on('ChatMessageUpdated', function (data){
            $('#'+data.id).find('span').text(data.message);

         })

         // scrollChat static Function
        
         function scrollChat(){
            $('#chat-container').animate({
               scrollTop:$('#chat-container').offset().top + $('#chat-container')[0].scrollHeight
            },0)
         }
         
         socket.on('ChatMessageDeleted', function(id){
            $('#'+id).remove(); 
         })
          </script>
   </body>
</html>